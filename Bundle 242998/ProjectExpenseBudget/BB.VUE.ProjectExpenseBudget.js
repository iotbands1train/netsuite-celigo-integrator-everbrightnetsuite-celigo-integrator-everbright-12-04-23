Vue.use(window.vuelidate.default)
const _tempData = {"seqName":"Week","seqCount":15,"id":"1","projectId":"558665","project":{"id":"558665","name":"PROJ-332","url":"/app/accounting/project/project.nl?id=558665&compid=TSTDRV1910037"},"salesOrder":{"id":"34398","name":"CUS-1026 Arlene Gilbert","url":"/app/accounting/transactions/salesord.nl?id=34398&compid=TSTDRV1910037"},"salesOrderId":"34398","sections":[{"itemId":"1856","parentId":"","title":"Agency Fees and Outside Services","sequenceNum":"0","items":[{"itemId":"1673","parentId":"1856","title":"Permit Preparation","sequenceNum":"1","id":"1","amount":"10000.00","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]},{"itemId":"1674","parentId":"1856","title":"EPA Submission preparation","sequenceNum":"3","id":"12","amount":"9000.00","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"id":"12","seq":"9","amount":"9000.00"},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]},{"itemId":"1675","parentId":"1856","title":"Outside legal review","sequenceNum":"4","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]},{"itemId":"1676","parentId":"1856","title":"Permit fees","sequenceNum":"5","id":"2","amount":"","seqData":[{"seq":1},{"id":"1","seq":"2","amount":"5000.00"},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]}],"collapsed":false},{"itemId":"1857","parentId":"","title":"Development Fees","sequenceNum":"0","items":[{"itemId":"1756","parentId":"1857","title":"Development Fee Cost","sequenceNum":"1","id":"13","amount":"","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"id":"13","seq":"11","amount":"13000.00"},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]}],"collapsed":false},{"itemId":"1858","parentId":"","title":"Electrical Equipment","sequenceNum":"0","items":[{"itemId":"1657","parentId":"1858","title":"Modules","sequenceNum":"1","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]},{"itemId":"1658","parentId":"1858","title":"Inverters","sequenceNum":"2","id":"3","amount":"","seqData":[{"seq":1},{"seq":2},{"id":"2","seq":"3","amount":"3000.00"},{"seq":4},{"seq":5},{"id":"3","seq":"6","amount":"2000.00"},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]},{"itemId":"1659","parentId":"1858","title":"Combiners, fuses, wire","sequenceNum":"3","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]},{"itemId":"1660","parentId":"1858","title":"Transformers","sequenceNum":"4","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]},{"itemId":"1648","parentId":"1858","title":"Monitoring","sequenceNum":"5","id":"4","amount":"5000.00","seqData":[{"seq":1},{"seq":2},{"seq":3},{"id":"4","seq":"4","amount":"5000.00"},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]},{"itemId":"1662","parentId":"1858","title":"Meter","sequenceNum":"6","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]},{"itemId":"1663","parentId":"1858","title":"Conduit","sequenceNum":"7","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]},{"itemId":"1664","parentId":"1858","title":"Misc electrical","sequenceNum":"8","id":"15","amount":"","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]},{"itemId":"1665","parentId":"1858","title":"Electrical labor","sequenceNum":"9","id":"5","amount":"","seqData":[{"id":"5","seq":"1","amount":"1000.00"},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]}],"collapsed":false},{"itemId":"1859","parentId":"","title":"Interest Reserves","sequenceNum":"0","items":[{"itemId":"1677","parentId":"1859","title":"Interest Reserve Cost","sequenceNum":"1","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]}],"collapsed":false},{"itemId":"1860","parentId":"","title":"Land","sequenceNum":"0","items":[{"itemId":"1656","parentId":"1860","title":"Land Cost","sequenceNum":"1","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]}],"collapsed":false},{"itemId":"1861","parentId":"","title":"Misc Closing Costs","sequenceNum":"0","items":[{"itemId":"1757","parentId":"1861","title":"Closing Costs","sequenceNum":"1","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]}],"collapsed":false},{"itemId":"1862","parentId":"","title":"Operating Deficit Reserves","sequenceNum":"0","items":[{"itemId":"1678","parentId":"1862","title":"Operating Deficit Reserve Cost","sequenceNum":"1","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]}],"collapsed":false},{"itemId":"1863","parentId":"","title":"Site Setup","sequenceNum":"0","items":[{"itemId":"1670","parentId":"1863","title":"Heavy equipment","sequenceNum":"1","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]},{"itemId":"1671","parentId":"1863","title":"Survey","sequenceNum":"2","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]},{"itemId":"1672","parentId":"1863","title":"Layout","sequenceNum":"3","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]}],"collapsed":false},{"itemId":"1864","parentId":"","title":"Structural Equipment","sequenceNum":"0","items":[{"itemId":"1666","parentId":"1864","title":"Ground screws","sequenceNum":"1","id":"14","amount":"","seqData":[{"id":"14","seq":"1","amount":"10000.00"},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]},{"itemId":"1667","parentId":"1864","title":"Racking & Rail","sequenceNum":"2","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]},{"itemId":"1668","parentId":"1864","title":"Structural heavy equipment","sequenceNum":"3","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]},{"itemId":"1669","parentId":"1864","title":"Structural labor","sequenceNum":"4","seqData":[{"seq":1},{"seq":2},{"seq":3},{"seq":4},{"seq":5},{"seq":6},{"seq":7},{"seq":8},{"seq":9},{"seq":10},{"seq":11},{"seq":12},{"seq":13},{"seq":14},{"seq":15}]}],"collapsed":false}]};
const app = new Vue({
  el: '#app'
  , data: {
    form: undefined
    , searchProjects: {
      term: ''
      , found: []
      , searching: false
      , delay: undefined
    }
    , focusedLineIdx: -1
    , focusedSectionIdx: -1
    , focusedSequence: -1
    , savingForm: false
    , loading: true
    , redirecting: false
    , focusedMoveItemsCount: 0
    , focusedInvalidMovePrevCount: 0
    , movingItems: false
    , showVersionModal: false
    , tempVersionName: ''
    , selectedVersion: null
    , hasNewVersionSet: false
    , todaySeq: 1
    , showHistorySeq: false
    , showHistorySeqCount: 5
    , formatFunc: undefined
    //, canDivide: false
  }
  , created: function () {
    var _this = this;
    if(!this.formatFunc) {
      require(['N/format'], function(formatModule){
        _this.formatFunc = function(v) {
          return formatModule.format({value: v, type: formatModule.Type.CURRENCY});
        }
      });
    }
    this.getData();
  }
  , computed: {
    isLoaded: function () {
      return typeof this.form.view !== 'undefined';
    }
    , formattedStart: function(){
      return this.formatDate(this.form.projectDates.start);
    }
    , formattedEnd: function(){
      return this.formatDate(this.form.projectDates.end);
    }
    , totalAmount: function() {
      var _totalAmount = 0;
      if(this.form && this.form.sections) {
        this.form.sections.forEach(function(section){
          if(section.items) {
            section.items.forEach(function(item){
              if(!isNaN(parseFloat(item.amount))) {
                _totalAmount += parseFloat(item.amount);
              }
            });
          }
        })
      }
      return this.formatCurrency(_totalAmount); // typeof nlapiFormatCurrency === 'function' ? nlapiFormatCurrency(_totalAmount) : _totalAmount;
    }
    , canDivide: function(){
      return this.form && this.form.seqCount && this.form.sections && this.focusedSectionIdx > -1 && this.focusedLineIdx > -1 && this.form.sections[this.focusedSectionIdx].items[this.focusedLineIdx].amount;
    }
    , canSum: function(){
      return this.form && this.form.sections && this.focusedSectionIdx > -1 && this.focusedLineIdx > -1
        && isNaN(parseFloat(this.form.sections[this.focusedSectionIdx].items[this.focusedLineIdx].amount))
        && this.form.sections[this.focusedSectionIdx].items[this.focusedLineIdx].seqData instanceof Array
        && this.form.sections[this.focusedSectionIdx].items[this.focusedLineIdx].seqData.filter(function(seq){
          return !isNaN(parseFloat(seq.amount));
        }).length;
    }
    , canAddSeq: function(){
      return this.form && ((this.form.maxSeqCount && this.form.seqCount < this.form.maxSeqCount) || !this.form.maxSeqCount);
    }
    , canMoveNext: function(){
      // return this.focusedMoveItemsCount > 0 && this.focusedSequence > -1 && !this.movingItems;
      return this.showMoveSeq && this.focusedSequence > -1;
    }
    , canMovePrev: function(){
      // return this.focusedMoveItemsCount > 0 && this.focusedSequence > 1 && !this.movingItems;
      return this.showMoveSeq && this.focusedSequence > 1;
    }
    , canDeleteSeq: function() {
      var
        _this = this
        , _hasDataInSeq = this.focusedSequence > -1 && this.form && this.form.sections instanceof Array
        && this.form.sections.filter(function(section) {
          return section.items instanceof Array && section.items.filter(function(item){
            return !isNaN(parseInt(item.seqData[_this.focusedSequence - 1].amount));
          }).length > 0
        }).length > 0
        , _canDeleteSeq = this.focusedSequence > -1 && !_hasDataInSeq && this.form.projectDates
        && (!(this.form.projectDates.end instanceof Date) || this.form.projectDates.end > this.form.projectDates.originalEnd)
      ;
      //console.log('canDeleteSeq', _canDeleteSeq);
      return _canDeleteSeq;
    }
    , disableMovePrev: function() {
      return !this.canMovePrev || this.movingItems
      || this.focusedInvalidMovePrevCount > 0 || this.focusedMoveItemsCount === 0 || this.getDates(this.focusedSequence - 1).start < new Date();
    }
    , disableMoveNext: function() {
      return !this.canMoveNext || this.movingItems || this.focusedMoveItemsCount === 0 || this.getDates(this.focusedSequence).start < new Date();
    }
    , disableDelete: function() {
      //console.log('disableDelete this.canDeleteSeq', this.canDeleteSeq);
      //console.log('disableDelete', !this.canDeleteSeq || this.movingItems || this.getDates(this.focusedSequence).start < new Date());
      return !this.canDeleteSeq || this.movingItems || this.getDates(this.focusedSequence).start < new Date();
    }
    , showMoveSeq: function() {
      return this.focusedSequence > -1;
    }
    , hasHistory: function() {
      return this.todaySeq - this.showHistorySeqCount > 0;
    }
    , canDeleteVersion: function(){
      return this.form && this.form.version && !this.hasNewVersionSet && this.selectedVersion && this.selectedVersion.readonly;
    }
    , canResetVersion: function(){
      return this.form && this.form.version && !this.hasNewVersionSet && this.form.version.versions.length == 1 && this.selectedVersion && /current/i.test(this.selectedVersion.name);
    }
  }
  , validations: function(){
    const currency = function(value) {
      if(typeof value === 'string') {
        value = value.replace(/\.+$/g, '');
        value = value.replace(',', '');
      }
      return window.validators.decimal(value);
    };

    return {
      form: {
        sections: {
          $each: {
            items: {
              $each: {
                amount: {
                  currency: currency
                },
                seqData: {
                  $each: {
                    amount: {
                      currency: currency
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
  , methods: {
    formatCurrency: function(value){
      if(!this.formatFunc) {
        require(['N/format'], function(formatModule){
          this.formatFunc = function(v) {
            return formatModule.format({value: v, type: formatModule.Type.CURRENCY});
          }
        });
      }

      if(this.formatFunc) {
        return this.formatFunc(value);
      }
      return value;
    }
    , buildUrl: function(process) {
      var
        _baseUrl = window.location
        , _process = ['process', process].join('=')
        , _params = []
        , _url = [_baseUrl, _process].join('&')
      if(this.selectedVersion) {
        _params.push(['peid', this.selectedVersion.id].join('='));
      }
      if(_params.length > 0) {
        _url = [_url, _params.join('&')].join('&');
      }
      return _url;
    }
    , projectFilter: function(){
      console.log('projectFilter', new Date());
      var
        _this = this
        , _baseUrl = window.location
        , _process = ['process', 'projects'].join('=')
        , _term
        , _url
      ;
      if(typeof _this.searchProjects.term === 'string' && _this.searchProjects.term.length > 0) {
        console.log(_this.searchProjects.term);
        _term = ['term', _this.searchProjects.term.trim()].join('=');
        _url = [_baseUrl, _process, _term].join('&');
        _this.searchProjects.searching = true;
        // do call to Suitelet
        if (typeof jQuery !== 'undefined') {
          jQuery.get(_url, function (response) {
            if(response instanceof Array){
              response.forEach(function(f){
                f.hover = false;
              })
              _this.searchProjects.found = response;
            }
          }).always(function () {
              setTimeout(function(){
                _this.searchProjects.searching = false;
              }, 500);
            });
        }
      }
    }
    , projectFilterDelay: function() {
      var _this = this;
      if(_this.searchProjects.delay) {
        clearTimeout(_this.searchProjects.delay);
      }
      console.log('projectFilterDelay', new Date());
      _this.searchProjects.delay = setTimeout(function(){
        _this.projectFilter();
      }, 300);
    }
    , addSequence: function(){
      var _this = this;
      this.form.seqCount++;
      this.form.sections.forEach(function(section){
        section.items.forEach(function(item){
          item.seqData.push({
            seq: _this.form.seqCount
            , amount: ''
          })
        });
      });

    }
    , focusSequence: function(seq) {
      if(this.focusedSequence == seq || (this.selectedVersion && this.selectedVersion.readonly)) {
        this.focusedSequence = -1;
      } else {
        this.focusedSequence = seq;
        this.calculateSelectedMoveItems();
      }
    }
    , divideOverSequences: function(){
      var
        _item = this.form.sections[this.focusedSectionIdx].items[this.focusedLineIdx]
        , _amount = Number(_item.amount)
        , _per = 0
        , _preCount = 0
        , _preTotal = _item.seqData.reduce(function(total, seq){
          if(!isNaN(parseFloat(seq.amount))){
            _preCount++;
            return total + Number(seq.amount);
          }
          return total;
        }, 0)
        , _difference = _amount - _preTotal
        , _toUpdateCount = this.form.seqCount - _preCount
      ;
      _per = Number(Number(_difference / _toUpdateCount).toFixed(2));
      _item.seqData.forEach(function(seq){
        if(isNaN(parseFloat(seq.amount)) && _difference > 0){
          _difference = Number(_difference.toFixed(2));
          if(_toUpdateCount > 1){
            seq.amount = _per;
            _difference -= _per;
          } else {
            seq.amount = _difference;
          }
          _toUpdateCount--;
        }
      });
      this.$v.form.$touch();
    }
    , sumSequences: function(){
      var
        _item = this.form.sections[this.focusedSectionIdx].items[this.focusedLineIdx]
        , _amount = 0
      ;
      if(_item.seqData instanceof Array){
        _item.seqData.forEach(function(seq){
          _amount += isNaN(parseFloat(seq.amount)) ? 0 : Number(parseFloat(seq.amount).toFixed(2));
        });
        _item.amount = this.formatCurrency(_amount); // typeof nlapiFormatCurrency === 'function' ? nlapiFormatCurrency(_amount) : _amount;
      }
      this.$v.form.$touch();
    }
    , moveToNextSeq: function(){
      this.movingItems = true;
      var
        _this = this
        , _selected = this.focusedMoveItems()
        , _isSelectedItem
        , _hasDataInLastSeq = _selected.filter(function(item){
          return !isNaN(parseInt(item.seqData[_this.form.seqCount - 1].amount));
        }).length > 0
        , _projectDates
      ;
      if(_hasDataInLastSeq){
        this.form.seqCount++;
        if(this.form.projectDates.end instanceof Date){
          _projectDates = this.calculateSeqDate(this.form.projectDates.start, this.form.seqCount + 1);
          if(_projectDates > this.form.projectDates.end){
            this.form.projectDates.end = this.calculateSeqDate(this.form.projectDates.end, 2);
          }
        }
      }
      this.form.sections.forEach(function(section){
        section.items.forEach(function(item){
          _isSelectedItem = _selected.filter(function(s){ return s.itemId == item.itemId && s.parentId == item.parentId;})[0];
          if(_isSelectedItem) {
            item.seqData.splice(_this.focusedSequence - 1, 0, {
              seq: _this.focusedSequence
              , amount: ''
            });
            for(var i = _this.focusedSequence; i < _this.form.seqCount; i++){
                item.seqData[i].seq++;
            }
            if(!_hasDataInLastSeq){
              item.seqData.pop();
            }
          } else if(_hasDataInLastSeq) {
            item.seqData.push({
              seq: _this.form.seqCount
              , amount: ''
            })
          }
        });
      });

      this.focusedSequence++;
      this.movingItems = false;
      this.$v.form.$touch();
    }
    , moveToPrevSeq: function(){
      this.movingItems = true;
      var
        _this = this
        , _selected = this.focusedMoveItems()
        , _isSelectedItem
        , _hasDataInLastSeq = _selected.filter(function(item){
          return !isNaN(parseInt(item.seqData[_this.form.seqCount - 1].amount));
        }).length > 0
        , _projectDates = this.getDates(this.form.seqCount)
      ;
      if(_this.focusedSequence === 1){

      } else {
        _selected.forEach(function(item){
          item.seqData.splice(_this.focusedSequence - 2, 1);
          item.seqData.push({
            seq: _this.form.seqCount
            , amount: ''
          })
          for(var i = _this.focusedSequence - 2; i < _this.form.seqCount - 1; i++){
            item.seqData[i].seq--;
          }
        });
      }
      this.focusedSequence--;
      this.movingItems = false;
      this.$v.form.$touch();
    }
    , deleteSeq: function() {
      this.movingItems = true;
      if(this.canDeleteSeq) {
        var
          _this = this
          , _projectDates
        ;
        this.form.sections.forEach(function(section) {
          section.items.forEach(function (item) {
            for (var i = _this.focusedSequence; i <= _this.form.seqCount - 1; i++) {
              item.seqData[i].seq--;
            }
            item.seqData.splice(_this.focusedSequence - 1, 1);
          });
        });
        _this.form.seqCount--;
        if(_this.focusedSequence > _this.form.seqCount) {
          _this.focusedSequence--;
        }
        if(_this.form.projectDates.end instanceof Date){
          _projectDates = this.calculateSeqDate(this.form.projectDates.start, this.form.seqCount);
          if(_projectDates > this.form.projectDates.originalEnd){
            this.form.projectDates.end = this.calculateSeqDate(this.form.projectDates.end, 0);
          } else {
            this.form.projectDates.end = new Date(this.form.projectDates.originalEnd.getTime());
          }
        }
        this.$v.form.$touch();
      }
      this.movingItems = false;
    }
    , focused: function(sectionIdx, lineIdx){
      this.focusedSectionIdx = sectionIdx;
      this.focusedLineIdx = lineIdx;
      //this.canDivide = this.form && this.form.sections && this.focusedSectionIdx > -1 && this.focusedLineIdx > -1 && this.form.sections[this.focusedSectionIdx].items[this.focusedLineIdx].amount;
    }
    , toggleSection: function(idx){
      if(this.form && this.form.sections){
        this.form.sections[idx].collapsed =
          typeof this.form.sections[idx].collapsed === 'boolean' ? !this.form.sections[idx].collapsed : true;
      }
    }
    , submitForm: function (e) {
      var
        _this = this
        , _baseUrl = window.location
        , _process = ['process', 'save'].join('=')
        , _url = [_baseUrl, _process].join('&')
        , _dates = this.form.projectDates
      ;
        if (typeof jQuery !== "undefined") {
          _this.loading = true;
          jQuery.post(_url, JSON.stringify({
            id: this.form.id
            , projectId: this.form.projectId
            , salesOrderId: this.form.salesOrderId
            , sections: this.form.sections
            , seqCount: this.form.seqCount
            , updateEndDate: _dates.end instanceof Date && _dates.originalEnd instanceof Date && _dates.end > _dates.originalEnd
                ? _dates.end
                : undefined
            , versionName: this.form.setVersionName
          }), function (response) {
            if (/success/i.test(response.status)) {
              if(response.copy) {
                _url = [_baseUrl, ['process', 'copy'].join('=')].join('&')
                jQuery.post(_url, JSON.stringify({
                  id: _this.form.id || response.id
                  , projectId: _this.form.projectId
                  , sections: _this.form.sections
                  , versionName: _this.form.setVersionName
                }), function (response) {
                  if (/success/i.test(response.status)) {
                    if (response.redirect) {
                      _this.redirecting = true;
                      _this.getData();
                      _this.cancelVersion();
                      setTimeout(function(){
                        _this.loading = _this.redirecting;
                      }, 500);
                      // window.location.replace(response.redirect);
                    }
                  } else {
                    showAlertBox('peb_errors', 'Error', 'Error occurred, please contact administrator for support.', NLAlertDialog.TYPE_HIGH_PRIORITY);
                    setTimeout(function () {
                      hideAlertBox('peb_errors');
                    }, 5000);
                  }
                });
              } else if (response.redirect) {
                _this.redirecting = true;
                _this.getData();
                _this.cancelVersion();
                setTimeout(function(){
                  _this.loading = _this.redirecting;
                }, 500);
                // window.location.replace(response.redirect);
              }
            } else {
              showAlertBox('peb_errors', 'Error', 'Error occurred, please contact administrator for support.', NLAlertDialog.TYPE_HIGH_PRIORITY);
              setTimeout(function () {
                hideAlertBox('peb_errors');
              }, 5000);
            }
          }, 'json')
            .fail(function () {
              showAlertBox('peb_errors', 'Error', 'Error occurred, please contact administrator for support.', NLAlertDialog.TYPE_HIGH_PRIORITY);
              setTimeout(function () {
                hideAlertBox('peb_errors');
              }, 5000);
            })
            // .always(function () {
            //   setTimeout(function(){
            //     _this.loading = _this.redirecting;
            //   }, 500);
            // });
        } else {
          this.savingForm = true;
          setTimeout(function () {
            _this.savingForm = false;
          }, 5000);
        }
    }
    , getData: function(){
      const _this = this;
      _this.loading = true;
      var
        _baseUrl = window.location
        , _process = ['process', 'init'].join('=')
        , _url = [_baseUrl, _process].join('&')
      // simulate ajax call
      if(_this.selectedVersion) {
        _url = [_url, ['peid', _this.selectedVersion.id].join('=')].join('&');
      }
      if (typeof jQuery !== "undefined") {
        jQuery.get(_url, function (response) {
          if(response instanceof Object){
            Vue.set(_this, 'form', response);
            _this.form.moveSelectedPartial = false;
            if(!_this.selectedVersion && _this.form.version) {
              _this.selectedVersion = _this.form.version.currentVersion;
            }
            if(_this.form.projectDates){
              _this.form.projectDates.start = _this.form.projectDates.start
                ? new Date(_this.form.projectDates.start)
                : _this.form.projectDates.start;
              _this.form.projectDates.end = _this.form.projectDates.end
                ? new Date(_this.form.projectDates.end)
                : _this.form.projectDates.end;
              //_this.form.projectDates.formattedStart = _this.formatDate(_this.form.projectDates.start);
              //_this.form.projectDates.formattedEnd = _this.formatDate(_this.form.projectDates.end);
              _this.form.projectDates.originalStart = new Date(_this.form.projectDates.start);
              _this.form.projectDates.originalEnd = new Date(_this.form.projectDates.end);
            }
            _this.todaySeq = _this.calculateTodaysSeq(_this.form.projectDates.start);
            // console.log('_this.todaySeq', _this.todaySeq);
          } else {
            showAlertBox('peb_errors', 'Error', 'Error occurred, please contact administrator for support.', NLAlertDialog.TYPE_HIGH_PRIORITY);
            setTimeout(function () {
              hideAlertBox('peb_errors');
            }, 5000);
          }
        }).fail(function () {
          showAlertBox('peb_errors', 'Error', 'Error occurred, please contact administrator for support.', NLAlertDialog.TYPE_HIGH_PRIORITY);
          setTimeout(function () {
            hideAlertBox('peb_errors');
          }, 5000);
        })
          .always(function () {
            setTimeout(function(){
              _this.loading = false;
            }, 500);

          });
      } else {
        // setTimeout(function(){
        _this.form = _tempData;
        //   Vue.set(_this, 'form', _tempData);
        // }, 2000);
        _this.loading = false;
      }
    }
    , calculateSeqDate: function(date, sequence) {
      const _seqCalulateFunc = {
        'week': function(date, seq) {
          return date.setDate(date.getDate() + seq * 7);
        }
        , 'month': function(date, seq) {
          return date.setMonth(date.getMonth() + seq * 1);
        }
      };
      var
        _seqName = this.form ? this.form.seqName.toLowerCase() : undefined
      ;
      if(_seqCalulateFunc.hasOwnProperty(_seqName)) {
        return new Date(_seqCalulateFunc[_seqName](new Date(date), sequence - 1));
      }
      return undefined;
    }
    , calculateTodaysSeq: function(startDate) {
      const _seqCalulateFunc = {
        'week': function() {
          return parseInt(Math.floor((new Date() - startDate)/(1000*60*60*24*7))) + 1;
        }
        , 'month': function() {
          var _today = new Date();
          return (_today.getFullYear() - startDate.getFullYear()) * 12 + (_today.getMonth() - startDate.getMonth()) + 1;
        }
      };
      var
        _seqName = this.form ? this.form.seqName.toLowerCase() : undefined
      ;
      if(startDate instanceof Date && _seqCalulateFunc.hasOwnProperty(_seqName)) {
        return _seqCalulateFunc[_seqName]();
      }
      return 1;
    }
    , getDates: function(sequence){
      const _seqCalulateFunc = {
        'week': function(date, seq) {
          return date.setDate(date.getDate() + seq * 7);
        }
        , 'month': function(date, seq) {
          return date.setMonth(date.getMonth() + seq * 1, 1);
        }
      };

      var
        _dates = {
          start: null
          , end: null
        }
        , _seqFunc
      ;

      if(this.form && this.form.seqName
        && this.form.projectDates && this.form.projectDates.start instanceof Date
        && _seqCalulateFunc.hasOwnProperty(this.form.seqName.toLowerCase())) {
        _seqFunc = _seqCalulateFunc[this.form.seqName.toLowerCase()];
        _dates.start = new Date(_seqFunc(new Date(this.form.projectDates.start), sequence - 1));
        if(_dates.start < this.form.projectDates.start) {
          _dates.start = new Date(this.form.projectDates.start);
        }
        _dates.start.setHours(0,0,0,0);
        _dates.end = new Date(_seqFunc(new Date(this.form.projectDates.start), sequence));
        _dates.end.setDate(_dates.end.getDate()-1);
        if(this.form.projectDates.end instanceof Date && _dates.end > this.form.projectDates.end) {
          _dates.end = this.form.projectDates.end;
        }
        _dates.end.setHours(23, 59, 59, 999);
      }

      return _dates;
    }
    // , getStartDate: function(seq) {
    //   var _dates = this.getDates(seq);
    //   return this.formatDate(_dates.start);
    // }
    // , getEndDate: function(seq) {
    //   var _dates = this.getDates(seq);
    //   return this.formatDate(_dates.end);
    // }
    , getSeqTitle: function(seq) {
      var
        _this = this
        , _dates = this.getDates(seq)
        , _seqTypeFormat = {
          'week': [_this.formatDate(_dates.start), _this.formatDate(_dates.end)].join(' - ')
          , 'month': _this.formatDate(_dates.start, 'MON YYYY')
        }
      if(this.form && this.form.seqName
        && this.form.projectDates && this.form.projectDates.start instanceof Date
        && _seqTypeFormat.hasOwnProperty(this.form.seqName.toLowerCase())) {
        return _seqTypeFormat[this.form.seqName.toLowerCase()];
      }
      return seq;
    }
    , getSeqTooltip: function(seq) {
      //{{form.seqName}} {{n}}
      var
        _this = this
        , _dates = this.getDates(seq)
        , _seqTypeFormat = {
          'week': function() { return [_this.form.seqName, seq].join(' '); }
          , 'month': function() {
            return [_this.formatDate(_dates.start), _this.formatDate(_dates.end)].join(' - ');
          }
        }
      if(this.form && this.form.seqName
        && this.form.projectDates && this.form.projectDates.start instanceof Date
        && _seqTypeFormat.hasOwnProperty(this.form.seqName.toLowerCase())) {
        return _seqTypeFormat[this.form.seqName.toLowerCase()]();
      }
      return seq;
    }
    , isHistory: function(seq){
      return this.todaySeq - this.showHistorySeqCount > seq;
    }
    , sequenceAmount: function(line){
      var
        _seqAmount = 0;
      ;
      if(line){
        line.seqData.forEach(function(seq){
          if(!isNaN(parseFloat(seq.amount))){
            _seqAmount += parseFloat(seq.amount);
          }
        });
      }
      _seqAmount = Number(_seqAmount.toFixed(2));
      return _seqAmount;
    }
    , sameAmountAsSeq: function(line){
      var
        _amount = 0
        , _seqAmount = 0;
      ;
      if(line){
        _amount = parseFloat(line.amount);
        if(isNaN(_amount)) {
          _amount = 0;
        }
        _seqAmount = this.sequenceAmount(line);
      }
      return _amount != _seqAmount;
    }
    , varianceAmount: function(line){
      var
        _amount = 0
        , _seqAmount = 0;
      ;
      if(line){
        _amount = parseFloat(line.amount);
        if(isNaN(_amount)) {
          _amount = 0;
        }
        _seqAmount = this.sequenceAmount(line);
      }
      return this.formatCurrency(_amount - _seqAmount);
    }
    , totalAmountSeq: function(seq){
      const _this = this;
      var
        _totalAmountSeq = 0
        // , _seqData
      ;

      if(this.form && this.form.sections){
        this.form.sections.forEach(function(sec){
          _totalAmountSeq += _this.totalAmountSectionSeq(sec, seq, true);
          // if(sec.items){
          //   sec.items.forEach(function(item){
          //     if(item.seqData){
          //       _seqData = item.seqData.filter(function(s){
          //         return s.seq == seq;
          //       })[0];
          //       if(_seqData && _seqData.amount && !isNaN(parseFloat(_seqData.amount))){
          //         _totalAmountSeq += parseFloat(_seqData.amount);
          //       }
          //     }
          //   });
          // }
        });
      }
      _totalAmountSeq = Number(_totalAmountSeq.toFixed(2));
      return this.formatCurrency(_totalAmountSeq); // typeof nlapiFormatCurrency === 'function' ? nlapiFormatCurrency(_totalAmountSeq) : _totalAmountSeq;
    }
    , totalAmountSectionSeq: function(section, seq, ignoreFormat) {
      var
        _totalAmountSeq = 0
        , _seqData
      ;
      if(section && section.items){
        section.items.forEach(function(item){
          if(seq && item.seqData){
            _seqData = item.seqData.filter(function(s){
              return s.seq == seq;
            })[0];
            if(_seqData && _seqData.amount && !isNaN(parseFloat(_seqData.amount))){
              _totalAmountSeq += parseFloat(_seqData.amount);
            }
          } else if(!isNaN(parseFloat(item.amount))) {
            _totalAmountSeq += parseFloat(item.amount);
          }
        });
      }
      _totalAmountSeq = Number(_totalAmountSeq.toFixed(2));
      return !ignoreFormat ? this.formatCurrency(_totalAmountSeq) : _totalAmountSeq; // typeof nlapiFormatCurrency === 'function' && !ignoreFormat ? nlapiFormatCurrency(_totalAmountSeq) : _totalAmountSeq;
    }
    , isFocused: function(sectionIdx, lineIdx){
      return this.focusedSectionIdx == sectionIdx && this.focusedLineIdx == lineIdx;
    }
    , isSeqFocused:function(seqIdx){
      return (Number(seqIdx) + 1) == this.focusedSequence;
    }
    , formatDate: function(date, format){
      if(date instanceof Date && typeof getdatestring === 'function'){
        return getdatestring(date, format);
      }
      return date;
    }
    , focusedMoveItems: function(){
      var
        _selected = []
      ;
      if(this.form && this.form.sections instanceof Array)
        this.form.sections.forEach(function(section) {
          if(section.items instanceof Array) {
            _selected = _selected.concat(section.items.filter(function(item){
              return item.moveSelected;
            }));
          }
        });
      return _selected;
    }
    , selectMoveProject: function(event){
      var
        _this = this
        , _select = this.focusedMoveItems().length === 0
      ;
      if(this.form){
        this.form.sections.forEach(function(section){
          _this.selectMoveSection(section, _select, true);
        });
        this.updateMoveSelected();
        if(event){
          event.target.checked = this.form.moveSelected;
          event.target.indeterminate = this.form.moveSelectedPartial;
          //_event.preventDefault();
        }
        // this.form.moveSelected = this.projectSelectedForMove;
        // this.form.moveSelectedPartial = this.projectPartialSelectedForMove
      }
    }
    , selectMoveSection: function(section, force, skipUpdate){
      var
        _this = this
        , _select = force
        , _section = section //this.form && this.form.sections instanceof Array ? this.form.sections[sectionIdx] : undefined
        , _event
      ;
      if(_section && _section.items instanceof Array){
        if(_select instanceof Event){
          _event = _select;
          _select = undefined;
        }
        if(typeof _select === 'undefined') {
          _select = _section.items.filter(function(item){
            return item.moveSelected;
          }).length === 0;
        }
        _section.items.forEach(function(item){
          _this.selectMoveItem(item, _select, true);
        });
        this.updateMoveSelected(skipUpdate);
        if(_event){
          _event.target.checked = section.moveSelected;
          _event.target.indeterminate = section.moveSelectedPartial;
          //_event.preventDefault();
        }
      }
    }
    , selectMoveItem: function(item, force, skipUpdate){
      var
        _select = force
      ;
      if(typeof _select === 'undefined'){
        _select = !item.moveSelected;
      }
      item.moveSelected = _select;
      this.updateMoveSelected(skipUpdate);
    }
    , calculateSelectedMoveItems: function(){
      var _this = this;
      this.focusedMoveItemsCount = this.focusedMoveItems().length;
      this.focusedInvalidMovePrevCount = this.focusedMoveItems().filter(function(item){
        return item.seqData[_this.focusedSequence - 2] && item.seqData[_this.focusedSequence - 2].amount.trim().length > 0;
      }).length;
    }
    , updateMoveSelected: function(skipUpdate) {
      if(skipUpdate){ return; }
      if(this.form && this.form.sections instanceof Array) {
        var
          _this = this
          , _selected
          , _selectedPartial
        ;
        Vue.set(this.form, 'moveSelected', false);
        Vue.set(this.form, 'moveSelectedPartial', false);
        // this.form.moveSelected = false;
        // this.form.moveSelectedPartial = false;
        this.form.sections.forEach(function(section){
          Vue.set(section, 'moveSelected', false);
          Vue.set(section, 'moveSelectedPartial', false);
          // section.moveSelected = false;
          // section.moveSelectedPartial = false;
          if(section.items instanceof Array && section.items.length > 0) {
            _selected = section.items.filter(function(item){
              return item.moveSelected;
            }).length;
            Vue.set(section, 'moveSelected', _selected === section.items.length);
            Vue.set(section, 'moveSelectedPartial', _selected > 0 && _selected < section.items.length);

            // section.moveSelected = _selected === section.items.length;
            // section.moveSelectedPartial = _selected < section.items.length;
          }
        });
        _selected = this.form.sections.filter(function(section) {
          return section.moveSelected;
        }).length;
        _selectedPartial = this.form.sections.filter(function(section) {
          return section.moveSelectedPartial;
        }).length;
        if(_selectedPartial > 0 || (_selected > 0 && _selected < this.form.sections.length)) {
          Vue.set(this.form, 'moveSelectedPartial', true);
          // this.form.moveSelectedPartial = true;
        } else if(_selected > 0 && _selected === this.form.sections.length) {
          Vue.set(this.form, 'moveSelected', true);
          // this.form.moveSelected = true;
        }
        this.calculateSelectedMoveItems();
      }
    }
    , addVersion: function(name) {
      if(name) {
        this.form.setVersionName = name;
        this.form.version.baseLineIsSet = true;
        this.hasNewVersionSet = this.checkNewVersionSet();
      } else {
        this.showVersionModal = true;
      }
      this.$v.form.$touch();
    }
    , cancelNewVersion: function() {
      this.showVersionModal = false;
      this.tempVersionName = '';
      this.hasNewVersionSet = this.checkNewVersionSet();
    }
    , createNewVersion: function() {
      this.form.setVersionName = this.tempVersionName;
      this.cancelNewVersion();
    }
    , cancelVersion: function() {
      this.form.setVersionName = undefined;
      if(!this.form.version.canAddVersion && this.form.version.baseLineIsSet) {
        this.form.version.baseLineIsSet = false;
      }
      this.hasNewVersionSet = this.checkNewVersionSet();
    }
    , checkNewVersionSet: function() {
      return this.form && typeof this.form.setVersionName === 'string' && this.form.setVersionName.trim().length > 0;
    }
    , deleteVersion: function(){
      var
        _this = this
        , _baseUrl = window.location
        , _url = [_baseUrl, ['process', 'remove'].join('=')].join('&');
      ;
      if(this.selectedVersion){
        if (typeof jQuery !== "undefined") {
          _this.loading = true;
          _url = [_url, ['peid', _this.selectedVersion.id].join('=')].join('&');
          jQuery.post(_url, JSON.stringify({}), function (response) {
            if (response.success) {
              _this.selectedVersion = null;
                _this.redirecting = true;
                _this.getData();
                setTimeout(function () {
                  _this.loading = _this.redirecting;
                }, 500);
            } else {
              showAlertBox('peb_errors', 'Error', 'Error occurred, please contact administrator for support.', NLAlertDialog.TYPE_HIGH_PRIORITY);
              setTimeout(function () {
                hideAlertBox('peb_errors');
              }, 5000);
            }
          });
        }
      }
    }
    , exportData: function(){
      const
        _this = this
        , _url = this.buildUrl('download')
      ;
      _this.loading = true;

      // simulate ajax call
      if (typeof jQuery !== "undefined") {
        window.open(_url, '_blank');
        _this.loading = false;
      } else {
        _this.loading = false;
      }
    }
  }
});

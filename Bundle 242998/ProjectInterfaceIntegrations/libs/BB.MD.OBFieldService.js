/**
 * @NApiVersion 2.x
 * @NModuleScope Public
 *
 * Error codes used found at
 * https://restfulapi.net/http-status-codes/
 *
 * Copyright 2020 Blue Banyan Solutions, Inc.
 * All Rights Reserved.
 *
 * This software and information are proprietary to Blue Banyan Solutions, Inc.
 * Any use of the software and information shall be in accordance with the terms
 * of the license agreement you entered into with Blue Banyan Solutions, Inc,
 * including possible restrictions on redistribution, misuse, and alteration.
 */

/*
{
  "Checklist": {
    "Questions": [
      {
        "AnswerOptions": [
          {
            "Value": "Customer Selection 1"
          }
        ],
        "QuestionID": {
          "Value": "12345"
        },
        "QuestionLabel": {
          "Value": "System Size (kW)?"
        },
        "QuestionType": {
          "Value": "Text"
        },
        "QuestionUnits": {
          "Value": "num:powerItemType"
        },
        "RequirementLevel": {
          "Decimals": "",
          "EndTime": "",
          "Precision": "",
          "StartTime": "",
          "Unit": "",
          "Value": ""
        },
        "RequirementNotes": {
          "Decimals": "",
          "EndTime": "",
          "Precision": "",
          "StartTime": "",
          "Unit": "",
          "Value": ""
        }
      }
    ]
  }
}


{
	"Checklist": {
		"Contacts": [{
			"Address": {
				"AddrLine1": {
					"Value": ""
				},
				"AddressType": {
					"Value": ""
				},
				"City": {
					"Value": ""
				},
				"Country": {
					"Value": ""
				},
				"County": {
					"Value": ""
				},
				"Description": {
					"Value": ""
				},
				"StateProvince": {
					"Value": ""
				},
				"ZipPostalCode": {
					"Value": ""
				},
				"ContactID": {
					"Value": ""
				},
				"ContactTimezone": {
					"Value": ""
				},
				"ContactType": {
					"Value": ""
				},
				"Email": {
					"Value": ""
				},
				"FirstName": {
					"Value": "Colin"
				},
				"HomePhone": {
					"Value": ""
				},
				"LastName": {
					"Value": "Bates"
				},
				"MiddleName": {
					"Value": ""
				},
				"MobilePhone": {
					"Value": ""
				},
				"PreferredContactMethod": {
					"Value": ""
				}
			}
		}],
		"Questions": [{
				"Enumerations": [{
					"Value": ""
				}],
				"QuestionID": {
					"Value": "1"
				},
				"QuestionLabel": {
					"Value": "System Size (kW)?"
				},
				"QuestionType": {
					"Value": "xbrli:stringItemType"
				},
				"QuestionUnits": {
					"Value": "num:powerItemType"
				},
				"RequirementLevel": {
					"Value": "Required"
				},
				"RequirementNotes": {
					"Value": ""
				}
			},
			{
				"Enumerations": [{
					"Value": ""
				}],
				"QuestionID": {
					"Value": "2"
				},
				"QuestionLabel": {
					"Value": "System Size (kW)?"
				},
				"QuestionType": {
					"Value": "xbrli:stringItemType"
				},
				"QuestionUnits": {
					"Value": "num:powerItemType"
				},
				"RequirementLevel": {
					"Value": "Required"
				},
				"RequirementNotes": {
					"Value": ""
				}
			},
			{
				"Enumerations": [{
					"Value": ""
				}],
				"QuestionID": {
					"Value": "3"
				},
				"QuestionLabel": {
					"Value": "System Size (kW)?"
				},
				"QuestionType": {
					"Value": "xbrli:stringItemType"
				},
				"QuestionUnits": {
					"Value": "num:powerItemType"
				},
				"RequirementLevel": {
					"Value": "Required"
				},
				"RequirementNotes": {
					"Value": ""
				}
			},
			{
				"Enumerations": [{
					"Value": ""
				}],
				"QuestionID": {
					"Value": "4"
				},
				"QuestionLabel": {
					"Value": "System Size (kW)?"
				},
				"QuestionType": {
					"Value": "xbrli:stringItemType"
				},
				"QuestionUnits": {
					"Value": "num:powerItemType"
				},
				"RequirementLevel": {
					"Value": "Required"
				},
				"RequirementNotes": {
					"Value": ""
				}
			},
			{
				"Enumerations": [{
					"Value": ""
				}],
				"QuestionID": {
					"Value": "5"
				},
				"QuestionLabel": {
					"Value": "System Size (kW)?"
				},
				"QuestionType": {
					"Value": "xbrli:stringItemType"
				},
				"QuestionUnits": {
					"Value": "num:powerItemType"
				},
				"RequirementLevel": {
					"Value": "Required"
				},
				"RequirementNotes": {
					"Value": ""
				}
			},
			{
				"Enumerations": [{
					"Value": ""
				}],
				"QuestionID": {
					"Value": "6"
				},
				"QuestionLabel": {
					"Value": "System Size (kW)?"
				},
				"QuestionType": {
					"Value": "xbrli:stringItemType"
				},
				"QuestionUnits": {
					"Value": "num:powerItemType"
				},
				"RequirementLevel": {
					"Value": "Required"
				},
				"RequirementNotes": {
					"Value": ""
				}
			},
			{
				"Enumerations": [{
					"Value": ""
				}],
				"QuestionID": {
					"Value": "7"
				},
				"QuestionLabel": {
					"Value": "System Size (kW)?"
				},
				"QuestionType": {
					"Value": "xbrli:stringItemType"
				},
				"QuestionUnits": {
					"Value": "num:powerItemType"
				},
				"RequirementLevel": {
					"Value": "Required"
				},
				"RequirementNotes": {
					"Value": ""
				}
			}
		],
		"Answers": [{
				"AnswerValue": {
					"Unit": "Kilowatt",
					"Value": "10.01"
				},
				"FileFolderURL": {
					"Decimals": "",
					"EndTime": "",
					"Precision": "",
					"StartTime": "",
					"Unit": "",
					"Value": ""
				},
				"QuestionID": {
					"Value": "1"
				},
				"TransactionLineID": {
					"Value": ""
				}
			},
			{
				"AnswerValue": {
					"Unit": "Kilowatt",
					"Value": "10.01"
				},
				"FileFolderURL": {
					"Decimals": "",
					"EndTime": "",
					"Precision": "",
					"StartTime": "",
					"Unit": "",
					"Value": ""
				},
				"QuestionID": {
					"Value": "2"
				},
				"TransactionLineID": {
					"Value": ""
				}
			},
			{
				"AnswerValue": {
					"Unit": "Kilowatt",
					"Value": "10.01"
				},
				"FileFolderURL": {
					"Decimals": "",
					"EndTime": "",
					"Precision": "",
					"StartTime": "",
					"Unit": "",
					"Value": ""
				},
				"QuestionID": {
					"Value": "3"
				},
				"TransactionLineID": {
					"Value": ""
				}
			},
			{
				"AnswerValue": {
					"Unit": "Kilowatt",
					"Value": "10.01"
				},
				"FileFolderURL": {
					"Decimals": "",
					"EndTime": "",
					"Precision": "",
					"StartTime": "",
					"Unit": "",
					"Value": ""
				},
				"QuestionID": {
					"Value": "4"
				},
				"TransactionLineID": {
					"Value": ""
				}
			},
			{
				"AnswerValue": {
					"Unit": "Kilowatt",
					"Value": "10.01"
				},
				"FileFolderURL": {
					"Decimals": "",
					"EndTime": "",
					"Precision": "",
					"StartTime": "",
					"Unit": "",
					"Value": ""
				},
				"QuestionID": {
					"Value": "5"
				},
				"TransactionLineID": {
					"Value": ""
				}
			},
			{
				"AnswerValue": {
					"Unit": "Kilowatt",
					"Value": "10.01"
				},
				"FileFolderURL": {
					"Decimals": "",
					"EndTime": "",
					"Precision": "",
					"StartTime": "",
					"Unit": "",
					"Value": ""
				},
				"QuestionID": {
					"Value": "6"
				},
				"TransactionLineID": {
					"Value": ""
				}
			},
			{
				"AnswerValue": {
					"Unit": "Kilowatt",
					"Value": "10.01"
				},
				"FileFolderURL": {
					"Decimals": "",
					"EndTime": "",
					"Precision": "",
					"StartTime": "",
					"Unit": "",
					"Value": ""
				},
				"QuestionID": {
					"Value": "7"
				},
				"TransactionLineID": {
					"Value": ""
				}
			}
		],
		"ChecklistDate": {
			"EndTime": "2011-10-05T16:48:00.000Z",
			"StartTime": "2011-10-05T14:48:00.000Z"
		},
		"ChecklistType": {
			"Value": "Site"
		},
		"TransactionID": {
			"Decimals": "",
			"EndTime": "",
			"Precision": "",
			"StartTime": "",
			"Unit": "",
			"Value": ""
		}
	}
}
 */




define(['N/record','N/search',],
function(record, search) {

    function postFieldService(options) {
        // options should include the API Log with key=apilog
        /* options should look like this:
         {
            payload:payload,
            apilog:_apiLog,
            map:_fieldMap
         }
        */

        var _output = {};
        var apiErrors = [];
        log.debug('POST',options);

        // track down where this data ties to

        // Checklist.TransactionID.Value should be the sales order

        // Checklist.ChecklistDate.StartTime = scheduled date?
        // Checklist.ChecklistDate.EndTime = ?
        // Checklist.Contacts[] = tech scheduled

        // Checklist.Answers.TransactionLineID.Value should be the line on the sales order it's attached to

        // Checklist.Questions[] should perform an upsert to the custom record tied to the item used

        // Checklist.Answers[] will create a new record (also tied to the item used) of the answers

        // TODO: Task


        // the question custom record comes from the item on the sales order line
        //var questionRecordId = 'customrecord_xxx_test';
        var questionRecordId = '287';

        var payload = options.payload;

        var _checkList = payload.Checklist;

        if(_checkList.Questions && _checkList.Questions.length>0){
            // Find all the current questions associated with this custom record
            // this is the mapping record that maps the external source questions by ID to the internal custom record fields
            var mapping = [];
            var filters = [['custrecord_bb_question_record','is',questionRecordId]];
            var cols = ['custrecord_bb_question_record_fld_id', 'custrecord_bb_question_id', 'custrecord_bb_question_type',
                        'custrecord_bb_question_units', 'custrecord_bb_question_record'];
            // SuiteQL failed on getting the custrecord_bb_question_record
            search.create({type:'customrecord_bb_question_mapping',filters:filters,columns:cols})
                .run().each(function(r){mapping.push(r.toJSON().values);});

            // validate the current mapping record with the checklist questions
            for(var question in _checkList.Questions){

                // look for the UUID or QuestionID of this question in the mapping table
                // -- UPSERT the mapping table --
                // If does not exist, add then create a new field on the mapping
                // if it exists, update



                mapping.filter(function(m){})

                var label = question.QuestionLabel.Value;
                QuestionType
                QuestionID
            }

            // search the custom question record fields and compare for updates
            var questionRecordFields = [];
            var sql = `select 
                        internalid, 
                        fieldtype, 
                        name, 
                        fieldvaluetyperecord, 
                        ismandatory, 
                        recordtype, 
                        scriptid, 
                        isshowinlist, 
                        isstored, 
                        fieldvaluetype 
                       from 
                        customfield 
                       where 
                        recordtype = ?`;

            var results = query.runSuiteQL({
                query: sql,
                params:[questionRecordId]
            }).asMappedResults();




        }


        if(apiErrors.length>0) {
            // reformat NS date errors to respond with correct date format for ISO to match OB JSON formatting
            for(var err in apiErrors){
                if (/Invalid date value/i.test(err.message)) {
                    err.message = "Invalid date value. ISO date format expected. ( YYYY-MM-DD )"
                }
            }
            options.apilog.setValue({
                fieldId: 'error',
                value: JSON.stringify(apiErrors)
            });
            log.error('ERRORS',apiErrors);
            _output.Errors = apiErrors;
        }
        return _output;
    }

    function getRecordIds(rec,fieldId){
        var fldArray = rec.getField({fieldId:fieldId}).getSelectOptions();
        // convert array to key/pair
        var fldObj = {};
        for(var s=0; s<fldArray.length; s++){
            fldObj[fldArray[s].text.toUpperCase()] = fldArray[s].value
        }
        return fldObj;
    }
    function hasRecordField(options){
        // look for a field on a record
        var rec = record.create({type:options.recordType,isDynamic: true});
        try{
            // attempt to load the default form in order to show all fields
            var cfField = rec.getField({fieldId:'customform'});
            var cfFieldSelections = cfField.getSelectOptions();
            var defaultFormId;
            for(var f=0; f<cfFieldSelections.length; f++){
                if(parseInt(cfFieldSelections[f].value)<0){
                    defaultFormId = cfFieldSelections[f].value;
                    break;
                }
            }
            rec.setValue({fieldId:'customform',value:defaultFormId});
        } catch (e) {
            log.error('custom form error: '+e.name,e.message);
        }
        var fields = rec.getFields();
        return fields.indexOf(options.fieldId)>=0;
    }
    function getFieldTypes(rec,fieldId){
        var fldArray = rec.getField({fieldId:fieldId}).getSelectOptions();
        // convert array to key/pair
        var fldObj = {};
        for(var s=0; s<fldArray.length; s++){
            fldObj[fldArray[s].value] = fldArray[s].text
        }
        return fldObj;
    }

    /**
     *
     * @param options
     * @returns {Record|null}
     *
     * options.rectype, options.fieldtype and options.label are required
     *
     * https://netsuite.custhelp.com/app/answers/detail/a_id/10085/
     *
     * fieldtype values:
     * ["CHECKBOX", "CURRENCY", "DATE", "DATETIMETZ", "FLOAT", "DOCUMENT", "EMAIL", "TEXT", "HELP", "URL",
     * "IMAGE", "INLINEHTML", "INTEGER", "SELECT", "CLOBTEXT", "MULTISELECT", "PASSWORD", "PERCENT", "PHONE",
     * "RICHTEXT", "TEXTAREA", "TIMEOFDAY"]
     */
    function createField(options) {
        if (!options.rectype)
            throw error.create({
                name: 'MISSING_RECORD_TYPE',
                message: 'rectype is required',
                notifyOff: false
            });
        if (!options.label)
            throw error.create({
                name: 'MISSING_LABEL',
                message: 'label is required',
                notifyOff: false
            });

        var parentFldRecType;
        var fldPrefix;
        if(options.rectype.indexOf('customrecord')==0){
            parentFldRecType = 'customrecordcustomfield';
            fldPrefix = 'custrecord';
        } else if(options.rectype.indexOf('salesorder')==0){
            // this would need to be expanded for other tran types
            parentFldRecType = 'transactionBodyCustomField';
            fldPrefix = 'custbody';
            //options.rectype = 'transaction'
        } else if(options.rectype.indexOf('noninventoryitem')==0){
            parentFldRecType = 'itemCustomField';
            fldPrefix = 'custitem';
        }

        var field = record.create({
            type: parentFldRecType,
            isDynamic: true
        });
        //log.debug('custom field started',field);
        var fieldTypesObj = getFieldTypes(field,'fieldtype');
        log.debug('getFieldTypes - fieldTypesObj',fieldTypesObj);

        if (fieldTypesObj.hasOwnProperty(options.fieldtype.toUpperCase())){
            field.setText({fieldId:'fieldtype',text:fieldTypesObj[options.fieldtype.toUpperCase()]});
        } else {
            // case sensative text value
            field.setText({fieldId:'fieldtype',text:fieldTypesObj[options.fieldtype]});
        }
        log.debug('field type set',options.fieldtype);
        if(options.fieldtype.toUpperCase().indexOf('SELECT')>=0){
            if (!options.selectrecordtype)
                throw error.create({
                    name: 'MISSING_LIST_RECORD',
                    message: 'SELECT and MULTISELECT require the selectrecordtype',
                    notifyOff: false
                });
            if(isNaN(options.selectrecordtype)){
                var listOptionsObj = getRecordIds(field,'selectrecordtype');
                options.selectrecordtype = listOptionsObj[options.selectrecordtype.toUpperCase()];
            }
            field.setValue({fieldId:'selectrecordtype',value:options.selectrecordtype});
        }
        //log.debug('field selectrecordtype set',options.selectrecordtype);

        for(option in options){
            try{
                if(option=='rectype') continue;
                log.debug(option,options[option]);
                var isSelectFld = field.getField({fieldId:option}).type.indexOf('select')>=0;
                if(isSelectFld && isNaN(options[option])){
                    field.setText({fieldId:option,text:options[option]});
                } else {
                    field.setValue({fieldId:option,value:options[option]});
                }
            } catch (e) {
                log.error(e.name,e.message);
            }
        }

        var fieldType = field.getValue({fieldId:'fieldtype'});
        var label = field.getValue({fieldId:'label'});
        var scriptId = field.getValue({fieldId:'scriptid'});

        if(scriptId.indexOf(fldPrefix)!=0) scriptId = scriptId.replace(fldPrefix,'');
        var fullScriptId = fldPrefix+scriptId;

        if(parentFldRecType == 'customrecordcustomfield'){
            rec = record.create({type:options.rectype});
            var fields = rec.getFields();
            log.debug('fields',fields);


            if(fields.indexOf(fullScriptId)>=0){
                log.debug('field sciptid already exists',fullScriptId);
                // TODO: error
            }
            // look for the labels
            var labels = [];
            for(var f=0; f<fields.length; f++) {
                var fieldId = fields[f];
                if (fieldId.indexOf('custrecord') != 0) continue;
                var recField = rec.getField({fieldId:fieldId});
                //log.debug(fieldId,recField);
                if(recField) labels.push(recField.label);
            }
            log.debug('labels',labels);
            if(labels.indexOf(label)>=0){
                log.debug('field label already exists',label);
                // TODO: error
            }

            field.setValue({fieldId:'rectype',value:getRecordId(options.rectype)});

        } else {
            // TODO: not sure how to get a list of current custom fields for things like transactions/items
        }

        log.debug('custom field to use before save',field);
        try {
            var internalid = field.save();
            var fldRec = record.load({type: parentFldRecType, id: internalid});
            return fldRec;
        } catch (e) {
            log.error(e.name, e.message);
            //log.error(t+' current Field', field);
            // DUP_CSTM_FIELD - This custom field already exists
            // did it fail because of the scriptid or the label???
            scriptId = field.getValue({fieldId:'scriptid'});
            try{
                if(scriptId.indexOf(fldPrefix)!=0) scriptId = scriptId.replace(fldPrefix,'');
                var fullScriptId = fldPrefix+scriptId;
                //log.debug(t+' attempt to load '+parentFldRecType,fullScriptId);
                var existingFldRec = record.load({type: parentFldRecType, id: fullScriptId});
            } catch(sError) {
                log.error(sError.name,sError.message);
            }

            // if(existingFldRec){
            //     //log.debug(t+' scriptid match',scriptId);
            //     if(t==0) fldScriptId += '_0';
            //     else fldScriptId = fldScriptId.substr(0,fldScriptId.length-2) +'_'+t;
            //     // check for next id and label
            //     field.setValue({fieldId:'scriptid',value:fldScriptId});
            // } else {
            //     //log.debug(t+' label match',label);
            //     if(t==0) label += ' 0';
            //     else label = label.substr(0,label.length-2) +' '+t;
            //     // check for next id and label
            //     field.setValue({fieldId:'label',value:label});
            // }
        }

        return null;
    }

    return {
        name: 'FieldService',
        post: postFieldService
    };
});
